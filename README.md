# SillyTavern-GPT-SoVITS Middleware

![License](https://img.shields.io/badge/license-MIT-blue) ![Python](https://img.shields.io/badge/python-3.8+-yellow) ![SillyTavern](https://img.shields.io/badge/SillyTavern-Extension-purple)

这是一个为 **SillyTavern (酒馆)** 量身打造的 **GPT-SoVITS** 深度集成插件。

它不仅仅是一个简单的 TTS 连接器，它包含一个 Python 后端管理器和一个前端 JS 插件，提供了模型自动切换、音频缓存、以及**多达 12 种不同风格**的沉浸式语音气泡体验。

---

## ✨ 核心功能

### 🎛️ 管理面板 (v1.3.0 新增)
* **📊 系统仪表盘**：访问 `http://localhost:3000/admin-ui` 查看系统状态、版本信息、缓存统计等。
* **🤖 模型管理**：可视化查看、创建模型,支持直接上传 `.pth` 和 `.ckpt` 权重文件。
* **🎵 参考音频管理**：在线播放、重命名、批量修改情绪前缀、删除音频文件,告别手动文件管理。
* **⚙️ 系统设置**：直接在网页中修改配置,无需手动编辑 JSON 文件。

### 🔄 自动更新系统 (v1.3.0 新增)
* **版本检测**：自动检查 GitHub 上的最新版本,仪表盘红点提醒。
* **一键更新**：支持 Git 仓库自动 `git pull`,或 ZIP 下载用户智能更新。
* **智能处理**：自动暂存本地修改、清理跟踪文件、更新后自动重启服务。

### 🎧 极致视听体验
* **沉浸式语音气泡**：在对话消息旁生成类似微信/Messenger 的语音条，支持律动动画和时长显示。
* **🎨 12款内置皮肤**：从二次元到赛博朋克，从古风水墨到硬核战术，一键切换（详情见下文）。
* **🖼️ 美化卡支持**：独家支持 **Iframe Mode**，完美兼容各类高度定制化的“美化卡”排版，气泡风格自动注入。

### 🤖 自动化与性能
* **多模型自动切换**:根据说话的角色,自动向 GPT-SoVITS 切换对应的 GPT 权重和 SoVITS 权重。
* **⚡ 智能哈希缓存**:基于 MD5 精准校验(文本+情感+提示词),命中缓存即 0 延迟秒开,大幅降低显卡负载。
* **🔄 队列调度系统**:内置 FIFO 任务队列,防止并发请求导致显存溢出,后台静默生成,前台流畅阅读。
* **🎲 情绪音频随机化**：同一情绪下有多个参考音频时,系统会随机选择,让生成的语音更加多样化。

### 🎯 交互增强
* **⭐ 收藏系统**:右键语音气泡即可收藏喜欢的语音,支持数据库持久化存储,完美兼容 Iframe 模式。
* **🎲 重Roll功能**:对 AI 生成的语音不满意?右键菜单一键重新生成,支持多次尝试直到满意为止。
* **🎨 美化右键菜单**:精心设计的上下文菜单,风格与气泡 UI 保持一致,提供流畅的交互体验。
* **📱 手机端UI优化**:专为移动设备优化的触控界面,包括浮动触发按钮、遮罩层、返回按钮等,操作更加便捷。

### 📡 远程与多端
* **📱 手机端/远程模式**：支持“后端跑在电脑，前端用手机酒馆”的远程连接模式。
* **可视化配置面板**：直接在酒馆界面内绑定角色、管理模型、调整路径。

---

## 🎨 视觉风格 (Visual Styles)

本插件内置了 12 种精心调教的 CSS 风格，可在配置面板中实时切换，适配不同的角色扮演场景：

| 风格名称 | 关键词 | 适用场景 |
| :--- | :--- | :--- |
| **🌿 森野·极简** | Default | 默认风格，清新的绿色渐变，适合大多数日常对话 |
| **💎 幻彩·琉璃** | Kawaii | 磨砂玻璃 + 幻彩渐变，适合二次元、软萌、偶像角色 |
| **⚡ 赛博·霓虹** | Cyberpunk | 高对比度黑底 + 霓虹蓝紫光晕，适合未来都市、黑客 |
| **✒️ 水墨·烟雨** | Ink | 宣纸纹理 + 丹砂红点缀，适合修仙、古风、武侠 |
| **🌸 花信·初绽** | Bloom | 樱花粉色调，适合恋爱、治愈系剧本 |
| **📜 羊皮·史诗** | Scroll | 泛黄羊皮纸 + 双线边框，适合 D&D、西幻、中世纪 |
| **💋 魅影·微醺** | Rouge | 酒红天鹅绒 + 金色边框，适合吸血鬼、御姐、深夜情感 |
| **🛸 星舰·光环** | Holo | 纯净的白色与全息冰蓝，适合太空歌剧、高科技 AI |
| **⚙️ 蒸汽·机械** | Steampunk | 黄铜色泽 + 铆接纹理，适合工业革命、维多利亚风格 |
| **📼 旧日·回溯** | Classic | 经典方角设计，致敬旧版 UI |
| **🌑 黑曜石·极夜** | Obsidian | 极简深色磨砂 + 宝石切面感，适合冷酷、商务风格 |
| **🟢 战术·指令** | Tactical | 纯黑底 + 荧光毒液绿，模拟军用 HUD，适合特工、废土 |

---

## 💡 技术原理 (How it Works)

为了保证极致的响应速度并保护你的显卡，本插件采用了多层优化策略：

### 1. 智能哈希缓存 (Smart MD5 Caching)
每当需要生成语音时，后端会计算唯一的 **MD5 哈希值**：
`Hash = MD5(文本内容 + 情感标签 + 参考音频路径 + 提示词文本)`

* **内存/磁盘双重检查**：优先读取内存，其次读取磁盘文件。
* **0 GPU 占用**：命中缓存时，完全不需要 GPU 参与，响应时间 < 10ms。

### 2. 自动预生成与队列调度
开启“自动预生成”后：
1.  **监听消息**：插件静默解析 AI 回复中的 `[TTSVoice]` 标签。
2.  **进入队列**：任务进入后台队列，**逐个生成**，避免爆显存。
3.  **无感体验**：当你读完文字点击气泡时，音频通常已经生成完毕。

### 3. 数据库持久化存储
* **SQLite 数据库**:收藏的语音数据使用 SQLite 进行持久化存储,确保数据安全可靠。
* **指纹机制**:基于消息 ID 和内容哈希生成唯一指纹 (`m{mesid}_{content_hash}`),精准匹配和管理语音数据。
* **Iframe 兼容**:通过 `window.SillyTavern.getContext().chat` API 获取消息数据,完美支持美化卡的 Iframe 环境。

---

## 🛠️ 前置要求

1.  **SillyTavern**: 已安装并运行。
2.  **GPT-SoVITS**: 需要部署并启动 API 服务（默认端口 `9880`）。
3.  **Python 3.8+**: 用于运行本插件的后端管理器。

---

## 🚀 安装与运行

### 第一步：在 SillyTavern 中安装扩展

1.  启动 SillyTavern。
2.  点击顶部菜单栏的 **Extensions (扩展)** 图标。
3.  点击 **Install Extension (安装扩展)**。
4.  在 URL 栏中粘贴本仓库地址：
    ```text
    [https://github.com/haide-D/SillyTavern-GPT-SoVITS](https://github.com/haide-D/SillyTavern-GPT-SoVITS)
    ```
5.  点击 **Install**。安装完成后，刷新页面。

### 第二步：启动后端服务 (Windows 一键启动)

1.  进入插件目录：`SillyTavern/public/scripts/extensions/你的仓库名/`
2.  双击运行 **`start.bat`**。
    * *脚本会自动安装 Python 依赖 (FastAPI, Uvicorn 等) 并启动服务。*
    * *默认端口：3000*
    * *启动后会自动在浏览器中打开管理面板 (`http://localhost:3000/admin-ui`)*
    * *如果是 Git 仓库,启动时会自动检查并拉取更新*

### 第三步：启动 GPT-SoVITS

确保你的 GPT-SoVITS 推理服务已开启（默认端口 `9880`）。

### 第四步：访问管理面板 (可选)

在浏览器中访问 `http://localhost:3000/admin-ui` 可以:
* 查看系统状态和版本信息
* 管理模型和参考音频文件
* 修改系统配置
* 检查并安装更新

---

## 📂 模型文件结构

为了让插件识别模型，请在插件目录下的 `MyCharacters` 文件夹中按以下结构组织文件。
（也可以在配置面板中修改 `Base Dir` 为你现有的 GPT-SoVITS 模型文件夹路径）

**⚠️ 关键规则：参考音频文件夹必须命名为 `reference_audios`**

```text
MyCharacters/
├── 阿米娅/                   <-- 模型名称 (文件夹名)
│   ├── gpt_weights.ckpt     <-- GPT 权重
│   ├── sovits_weights.pth   <-- SoVITS 权重
│   └── reference_audios/    <-- 参考音频存放处
│       │
│       ├── (模式A：简单模式)
│       ├── happy_你好博士.wav
│       ├── sad_我不想工作.wav
│       │
│       └── (模式B：多语言模式 - 推荐)
│           ├── Chinese/
│           │   └── emotions/
│           │       ├── happy_中文提示词.wav
│           │       └── sad_中文提示词.wav
│           ├── Japanese/
│           │   └── emotions/
│           │       └── default_日语提示词.wav
│           └── English/
│               └── ...

```

---

## 📝 音频命名规则 (情感识别)

为了让插件自动识别“情感”和“参考文本”，请严格按照以下格式命名音频文件：

**格式**：`情感_提示词内容.wav`

* `happy_你好我是测试.wav` 👉 情感识别为 **happy**，提示词为 **你好我是测试**
* `sad_我好难过.mp3` 👉 情感识别为 **sad**，提示词为 **我好难过**
* `普通对话.wav` 👉 (无下划线) 情感识别为 **default**，提示词为 **普通对话**

---

## 📱 常见问题 (FAQ)

**Q: 如何访问管理面板?**
A: 启动后端服务后,在浏览器中访问 `http://localhost:3000/admin-ui`。如果是远程连接,将 `localhost` 替换为服务器的 IP 地址。

**Q: 如何更新到最新版本?**
A: 
- **Git 用户**: 运行 `start.bat` 会自动检查更新,或在管理面板点击"检查更新"按钮。
- **ZIP 下载用户**: 在管理面板点击"检查更新",如果有新版本会提示一键更新。
- **手动更新**: 备份 `data/` 文件夹和 `system_settings.json`,下载最新版本覆盖即可。

**Q: 如何管理模型和参考音频?**
A: 在管理面板的"模型管理"页面可以查看所有模型,点击"查看音频"可以播放、重命名、批量修改情绪前缀或删除参考音频文件。

**Q: 手机端如何使用？**
A: 在电脑端启动插件后端。在手机端酒馆打开 TTS配置面板 -> 勾选"远程连接" -> 输入电脑的局域网 IP (如 `192.168.1.5`) -> 点击保存。

**Q: 我用了美化卡，气泡样式显示不正常怎么办？**
A: 打开 TTS配置面板，勾选 **"美化卡专用模式 (Iframe Mode)"**。这会将 CSS 样式强制注入到美化卡的内部框架中。

**Q: 点击气泡没有声音？**
A:

1. 检查后端黑色窗口是否有报错。
2. 检查 GPT-SoVITS 的 9880 端口是否开启。
3. 如果是远程连接，请确保手机和电脑在同一 WiFi 下，且防火墙允许了 3000 端口。

**Q: 如何使用收藏功能?**
A: 右键点击任意语音气泡,选择"收藏此语音"即可。收藏的语音会保存到数据库中,可以在收藏页面查看和管理。

**Q: 什么是重Roll功能?**
A: 如果对 AI 生成的语音效果不满意,可以右键点击气泡选择"重新生成",系统会使用相同的文本和参数重新生成一次语音,直到你满意为止。

**Q: 同一情绪有多个参考音频时如何选择?**
A: 系统会随机选择其中一个参考音频,让生成的语音更加多样化。例如有 `happy_text1.wav` 和 `happy_text2.wav` 时,每次生成会随机使用其中一个。

**Q: 手机端UI和桌面端有什么区别?**
A: 手机端提供了专门优化的触控界面,包括浮动触发按钮、全屏遮罩、大号返回按钮等,所有气泡风格在移动端和桌面端保持一致。
